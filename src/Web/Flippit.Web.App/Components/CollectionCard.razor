@using Flippit.Common.Models.Collection
@using Flippit.Common.Models.User
@using Flippit.Web.BL.Facades
@inject NavigationManager NavigationManager
@inject UserState userState
@inject IUserFacade userFacade


<div @onclick="Navigate" class="relative flex w-56 max-w-56 cursor-pointer flex-col gap-3 rounded-2xl bg-white p-4 drop-shadow">

    @if(userState.User != null && userState.User!.Id == collection.CreatorId)
    {
        <div hidden="@menuHidden" class="font-ubuntu-sans-l absolute top-10 right-3 w-30 gap-1 rounded-xl bg-gray-100 p-2 text-sm drop-shadow">
            <div @onclick="Edit" @onclick:stopPropagation class="flex cursor-pointer flex-row items-center rounded-md hover:bg-gray-50">
                <svg class="scale-75" width="27" height="24" viewBox="0 0 27 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M13.8887 3.95764H2C1.44771 3.95764 1 4.40536 1 4.95764V21.2221C1 21.7744 1.44772 22.2221 2 22.2221H18.1954C18.7477 22.2221 19.1954 21.7744 19.1954 21.2221V15.8123M20.5738 1.40757L9.17835 12.803C9.01512 12.9663 8.91339 13.1809 8.89042 13.4106L8.56546 16.6602C8.50247 17.2901 9.0332 17.8193 9.6629 17.7545L12.7767 17.4339C13.0054 17.4104 13.2189 17.3088 13.3815 17.1463L25.0882 5.4395C25.4385 5.1344 25.7249 4.11003 24.0682 2.45336C21.9974 0.382518 20.9657 1.01573 20.5738 1.40757Z" stroke="black" stroke-width="2" stroke-linecap="round" />
                </svg>
                <p>Edit</p>
            </div>
        </div>
    }


    <div class="flex flex-row items-center justify-between">
        <h5 class="font-monserrat-m text-22 m-0">@collection.Name</h5>

        @if(userState.User != null && (userState.User!.Id == collection.CreatorId || userState.User.Role == Common.Enums.Role.Admin))
        {
            <div @onclick="ToogleMenu" @onclick:stopPropagation class="scale-90 cursor-pointer rounded-sm p-1 hover:bg-gray-100">
                @{
                    if(menuHidden)
                    {
                        <svg width="18" height="13" viewBox="0 0 18 13" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M1 1H16.9346" stroke="black" stroke-width="2" stroke-linecap="round" />
                            <path d="M1 6.44415H16.9346" stroke="black" stroke-width="2" stroke-linecap="round" />
                            <path d="M1 11.8883H16.9346" stroke="black" stroke-width="2" stroke-linecap="round" />
                        </svg>
                    }
                    else
                    {
                        <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M1.00366 1L12.2711 12.2674" stroke="black" stroke-width="2" stroke-linecap="round" />
                            <path d="M1 12.2676L12.2674 1.00014" stroke="black" stroke-width="2" stroke-linecap="round" />
                        </svg>

                    }
                }
            

            </div>
        }

    </div>

    <div class="flex flex-col text-[14px]">
        <p class="font-ubuntu-sans-l m-0">Start time: @collection.StartTime.ToString("HH:mm - dd.MM.yyyy")</p>
        <p class="@GetDateClass(collection.EndTime) font-ubuntu-sans-l m-0">End time: @collection.EndTime.ToString("HH:mm - dd.MM.yyyy")</p>
    </div>

    <div class="flex flex-row items-end justify-between">
        <div class="flex flex-row justify-center gap-3">
            @if(creator != null)
            {
                <div class="size-5 overflow-hidden rounded-full">
                    @if(creator.PhotoUrl!=null)
                    {
                        <img src="@creator.PhotoUrl" class="size-full object-contain" />
                    }
                    else
                    {
                        <img src="/icons/user.svg" class="size-full object-contain" />
                    }
                </div>
                <p class="overflow-ellipsis">@creator.Name</p>
            }

        </div>
        <NavLink href="@($"/collections/{collection.Id}/play")">
            <div class="primary-blue-bg full flex size-10 cursor-pointer items-center justify-center rounded-full transition-all hover:scale-110">
                <svg class="scale-80" width="14" height="19" viewBox="0 0 14 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M13.5482 8.23899L1.55822 0.172003C0.893959 -0.274922 0 0.201075 0 1.00169V17.1357C0 17.9363 0.89396 18.4123 1.55822 17.9654L13.5482 9.89837C14.1373 9.50206 14.1373 8.6353 13.5482 8.23899Z" fill="#F0F2F6" />
                </svg>

            </div>
        </NavLink>

    </div>
    
</div>

@code {

    [Parameter]
    public required CollectionListModel collection { get; set; }

    private UserDetailModel? creator { get; set; }

    protected override async Task OnInitializedAsync()
    {
        userState.OnChange += StateHasChanged;
        if(collection!= null)
        {
             creator = await userFacade.GetByIdAsync(collection.CreatorId);
        }

        StateHasChanged();
    }

    private string GetDateClass(DateTime dateTime)
    {
        if (dateTime.AddDays(1) <= DateTime.Now)
        {
            return "text-red-400";
        }
        else return "";
    }

    private bool menuHidden = true;

    private void ToogleMenu()
    {
        menuHidden = !menuHidden;
    }

    private void Navigate()
    {
        NavigationManager.NavigateTo($"/collections/{collection.Id}");
    }

    private void Delete()
    {

    }

    private void Edit()
    {
        NavigationManager.NavigateTo($"/collections/{collection.Id}/edit");
    }
}
